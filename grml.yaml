# Copyright (c) 2024 skaldesh
# 
# This software is released under the MIT License.
# https://opensource.org/licenses/MIT

version: 2
project: gml

env:
    BINDIR:   ${ROOT}/bin
    BUILDDIR: ${ROOT}/build
    TRDIR:    ${ROOT}/resources/translations

import: 
    - grml.sh

options:
    debug: false

commands:
    clean:
        help: clean the build files.
        exec: |
            rm -rf ${BUILDDIR}

    translations:
        help: targets regarding translation files.
        commands:
            update:
                help: update the translation files by parsing the source.
                exec: |
                    # Generate translations.
                    lupdate \
                        ./Main.qml ./qml ./cpp \
                        -extensions qml,js,cpp,hpp \
                        -source-language en_US \
                        -ts \
                        "${TRDIR}/app_en.ts" \
                        "${TRDIR}/app_de.ts"
            release:
                help: release the current files by converting them to a binary representation.
                exec: |
                    lrelease \
                        "${NVISION_RESDIR}/languages/app_en.ts" \
                        "${NVISION_RESDIR}/languages/app_de.ts"

    build:
        help: build the Qt QML application.
        deps:
            - build.gobridge
        exec: |
            cmake \
                -G Ninja \
                -B ${BUILDDIR} \
                -S ${ROOT} \
                -DCMAKE_BUILD_TYPE=$(option ${debug} "Debug" "Release") \
                -DCMAKE_INSTALL_PREFIX=${BINDIR}

            ninja \
                -C ${BUILDDIR}

            # TODO: The installation does not yet work correctly. The "nVision" QML module is not installed in the target directory.
            #ninja \
            #    -C ${BUILDDIR} \
            #    install
        commands:
            gobridge:
                help: build the static go bridge.
                exec: |
                    go build \
                        -C go/ \
                        -o ${BUILDDIR}/go/go.a \
                        -buildmode=c-archive \
                        .
            run:
                help: build & run the Qt QML application.
                deps:
                    - build
                    - run

    run:
        help: run the Qt QML application.
        exec: |
            # TODO: Would like to run a static binary in the bin/ folder instead.
            ${BUILDDIR}/nVision-app